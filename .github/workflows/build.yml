name: Build Chomagerie
on:
    push:
        branches:
            - master
    pull_request:
    workflow_dispatch:
        inputs:
            platform:
                description: 'Platform to build for'
                required: true
                default: 'fabric'
                type: choice
                options:
                    - fabric
            releaseType:
                description: 'Release type'
                required: true
                default: 'stable'
                type: choice
                options:
                    - stable
                    - beta
                    - alpha
jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Setup JDK 21
                uses: actions/setup-java@v4
                with:
                    distribution: adopt
                    java-version: 21

            -   name: Setup Gradle
                uses: gradle/actions/setup-gradle@v4
                with:
                    gradle-home-cache-cleanup: true
                    cache-read-only: true

            -   name: Validate Gradle Wrapper Integrity
                uses: gradle/actions/wrapper-validation@v4

            -   name: Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: Gradle Release Build
                env:
                    RELEASE_WORKFLOW: true
                    PLATFORM: ${{ inputs.platform }}
                run: ./gradlew build

            -   name: Set environment variables for the script below
                run: |
                    echo "MINECRAFT_VERSION=$(./gradlew -q printMinecraftVersion)" >> $GITHUB_ENV
                    echo "MOD_VERSION=$(./gradlew -q printModVersion)" >> $GITHUB_ENV

            -   name: Upload Build Artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: Chomagerie-Mod
                    path: "build/libs/*.jar"

            -   name: Set Release Name
                run: |
                    if [ "${{ inputs.platform }}" == "fabric" ]; then
                      echo "RELEASE_NAME=Chomagerie $MOD_VERSION for Minecraft $MINECRAFT_VERSION Fabric" >> $GITHUB_ENV
                    fi

            -   name: Create GitHub Release
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    gh release delete mc${{ env.MINECRAFT_VERSION }}-${{ env.MOD_VERSION }} --yes || true
                    
                    # Determine if this is a prerelease based on version string or input
                    IS_PRERELEASE=false
                    if [[ "${{ env.MOD_VERSION }}" == *"SNAPSHOT"* ]] || [[ "${{ env.MOD_VERSION }}" == *"alpha"* ]] || [[ "${{ env.MOD_VERSION }}" == *"beta"* ]]; then
                      IS_PRERELEASE=true
                    fi
                    if [ "${{ inputs.releaseType }}" == "alpha" ] || [ "${{ inputs.releaseType }}" == "beta" ]; then
                      IS_PRERELEASE=true
                    fi
                    
                    gh release create mc${{ env.MINECRAFT_VERSION }}-${{ env.MOD_VERSION }} \
                      --title="${{ env.RELEASE_NAME }}" \
                      --notes-file=CHANGELOG.md \
                      --target=${{ github.ref_name }} \
                      --draft=false \
                      --prerelease=$IS_PRERELEASE \
                      build/libs/*[!sources].jar

            -   name: Publish to Modrinth
                if: github.ref == 'refs/heads/master' && github.event_name == 'push'
                env:
                    MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
                run: |
                    # Get the mod jar file (exclude sources)
                    MOD_JAR=$(ls build/libs/*[!sources].jar | head -1)
                    
                    # Determine release type
                    RELEASE_TYPE="release"
                    if [[ "${{ env.MOD_VERSION }}" == *"SNAPSHOT"* ]] || [[ "${{ env.MOD_VERSION }}" == *"alpha"* ]] || [[ "${{ env.MOD_VERSION }}" == *"beta"* ]]; then
                      if [[ "${{ env.MOD_VERSION }}" == *"alpha"* ]]; then
                        RELEASE_TYPE="alpha"
                      else
                        RELEASE_TYPE="beta"
                      fi
                    fi
                    
                    # Publish to Modrinth using curl
                    curl -X POST \
                      -H "Authorization: $MODRINTH_TOKEN" \
                      -H "Content-Type: multipart/form-data" \
                      -F "data={\"version_number\":\"${{ env.MOD_VERSION }}\",\"name\":\"Chomagerie ${{ env.MOD_VERSION }} for Minecraft ${{ env.MINECRAFT_VERSION }}\",\"changelog\":\"See GitHub release\",\"dependencies\":[],\"release_channel\":\"$RELEASE_TYPE\",\"loaders\":[\"fabric\"],\"game_versions\":[\"${{ env.MINECRAFT_VERSION }}\"],\"featured\":true}" \
                      -F "primary_file=@$MOD_JAR" \
                      "https://api.modrinth.com/v2/project/a6xYNYzI/version"
