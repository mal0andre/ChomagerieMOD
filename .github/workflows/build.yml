name: Build Chomagerie
on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build for'
        required: true
        default: 'fabric'
        type: choice
        options:
          - fabric
      releaseType:
        description: 'Release type'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - beta
          - alpha
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: adopt
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-home-cache-cleanup: true
          cache-read-only: true

      - name: Validate Gradle Wrapper Integrity
        uses: gradle/actions/wrapper-validation@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Gradle Release Build
        env:
          RELEASE_WORKFLOW: true
          PLATFORM: ${{ inputs.platform }}
        run: ./gradlew build

      - name: Set environment variables for the script below
        run: |
          echo "MINECRAFT_VERSION=$(./gradlew -q printMinecraftVersion)" >> $GITHUB_ENV
          echo "MOD_VERSION=$(./gradlew -q printModVersion)" >> $GITHUB_ENV

      # Prépare la liste des fichiers JAR à envoyer à Modrinth (exclut les -sources et -dev)
      - name: Prepare Modrinth files list
        id: prepare_modrinth_files
        run: |
          set -e
          FILES=$(ls -1 build/libs/*.jar 2>/dev/null | grep -v -E '(-sources\.jar$|-dev\.jar$)' || true)
          if [ -z "$FILES" ]; then
            FILES=$(ls -1 build/libs/*.jar 2>/dev/null || true)
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Map releaseType -> channel Modrinth
      - name: Set Modrinth channel
        run: |
          if [ "${{ inputs.releaseType }}" == "stable" ]; then
            echo "MODRINTH_CHANNEL=release" >> $GITHUB_ENV
          else
            echo "MODRINTH_CHANNEL=${{ inputs.releaseType }}" >> $GITHUB_ENV
          fi

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Chomagerie-Mod
          path: "build/libs/*.jar"

      - name: Set Release Name
        run: |
          if [ "${{ inputs.platform }}" == "fabric" ]; then
            echo "RELEASE_NAME=Chomagerie $MOD_VERSION for Minecraft $MINECRAFT_VERSION Fabric" >> $GITHUB_ENV
          fi

      # Vérifie que le CHANGELOG contient un en-tête « Release »
      - name: Check changelog for Release
        id: check_changelog
        run: |
          if grep -qiE '^\s*#+\s*\[?Release\]?([[:space:]]|$)' CHANGELOG.md; then
            echo "publish=true" >> $GITHUB_OUTPUT
          else
            echo "publish=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        if: github.event_name != 'pull_request' && !contains(github.event.head_commit.message, 'unrelease')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete mc${{ env.MINECRAFT_VERSION }}-${{ env.MOD_VERSION }} --yes || true
          
          # Determine if this is a prerelease based on version string or input
          IS_PRERELEASE=false
          if [[ "${{ env.MOD_VERSION }}" == *"SNAPSHOT"* ]] || [[ "${{ env.MOD_VERSION }}" == *"alpha"* ]] || [[ "${{ env.MOD_VERSION }}" == *"beta"* ]]; then
            IS_PRERELEASE=true
          fi
          if [ "${{ inputs.releaseType }}" == "alpha" ] || [ "${{ inputs.releaseType }}" == "beta" ]; then
            IS_PRERELEASE=true
          fi
          
          gh release create mc${{ env.MINECRAFT_VERSION }}-${{ env.MOD_VERSION }} \
            --title="${{ env.RELEASE_NAME }}" \
            --notes-file=CHANGELOG.md \
            --target=${{ github.ref_name }} \
            --draft=false \
            --prerelease=$IS_PRERELEASE \
            build/libs/*[!sources].jar

      # Publication sur Modrinth (utilise cloudnode-pro/modrinth-publish@v2) — seulement si « Release » dans le changelog et sur master/main
      - name: Publish to Modrinth
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') && steps.check_changelog.outputs.publish == 'true'
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRINTH_API_KEY }}
          project: ${{ vars.MODRINTH_PROJECT_ID }}
          name: ${{ env.RELEASE_NAME }}
          version: ${{ env.MOD_VERSION }}
          changelog: ${{ github.event.release.body }}
          channel: ${{ env.MODRINTH_CHANNEL }}
          loaders: |-
            fabric
          game-versions: ${{ env.MINECRAFT_VERSION }}
          files: ${{ steps.prepare_modrinth_files.outputs.files }}
